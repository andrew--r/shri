!function(t){function e(i){if(a[i])return a[i].exports;var n=a[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var a={};return e.m=t,e.c=a,e.p="",e(0)}([function(t,e,a){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function n(){window.application=new o.default}var s=a(2),o=i(s);document.addEventListener("DOMContentLoaded",n)},function(t,e){"use strict";function a(t){var e=Math.floor(t/60);return i(e)+":"+i(Math.round(t%60))}function i(t){var e=void 0;return e=t<10&&t>=1?"0"+Math.round(t):t<1?"00":t.toString()}function n(t){var e=t.split(":"),a=parseInt(e[0],10),i=parseInt(e[1],10),n=Math.round(parseFloat(e[2].replace(",","."),10));return n+60*i+60*a*60}function s(t,e){return Math.floor(Math.random()*(e-t+1))+t}function o(t,e){return Math.random()*(e-t)+t}Object.defineProperty(e,"__esModule",{value:!0}),e.formatSeconds=a,e.formattedTimeToSeconds=n,e.getRandomInt=s,e.getRandom=o},function(t,e,a){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var s=a(3),o=i(s),r=function u(){function t(t){var e=this;t.preventDefault(),Object.keys(this.links).forEach(function(t){e.links[t]=e.form.querySelector('[data-link-type="'+t+'"]').value}),this.pages.start.classList.remove(i),this.pages.main.classList.add(i),window.player=this.player=new o.default({root:this.root.querySelector(".player"),resources:this.links})}var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];n(this,u);var a=e.baseClass||"app",i=a+"__page_visible";this.root=document.querySelector("."+a),this.form=this.root.querySelector("."+a+"__form"),this.pages={start:this.root.querySelector("."+a+"__page_start"),main:this.root.querySelector("."+a+"__page_main")},this.links={video:"",subtitles:"",soundtrack:""},this.form.addEventListener("submit",t.bind(this))};e.default=r},function(t,e,a){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e,a){var i={x:(0,o.getRandomInt)(0,e),y:(0,o.getRandomInt)(0,a)},n=2.5,s={x:(0,o.getRandomInt)(i.x-n,i.x+n),y:(0,o.getRandomInt)(i.y-n,i.y+n)},r={x:(0,o.getRandomInt)(i.x-n,i.x+n),y:(0,o.getRandomInt)(i.y-n,i.y+n)},u=(0,o.getRandomInt)(0,150);t.strokeStyle="rgb("+u+", "+u+", "+u+")",t.lineWidth=10,t.beginPath(),t.moveTo(s.x,s.y),t.quadraticCurveTo(i.x,i.y,r.x,r.y),t.stroke()}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),o=a(1),r=function(){function t(e){function a(t){t.preventDefault(),this[this.isPlaying?"pause":"play"]()}var n=this,s=e.root,o=e.resources;i(this,t);var r="player",u=this.classes={base:r,stage:{base:r+"__stage"},canvas:{base:r+"__canvas"},subtitles:{base:r+"__subtitles",visible:r+"__subtitles_visible"},playButton:{base:r+"__control_state",paused:r+"__control_state_play",playing:r+"__control_state_pause"},video:{base:r+"__video"},time:{base:"time",watched:"time__watched",total:"time__total"},fakeVideo:{base:r+"__fakeVideo"},progress:{base:"progress",bar:"progress__bar"}},l=this.elements={root:s,stage:s.querySelector("."+u.stage.base),canvas:s.querySelector("."+u.canvas.base),subtitles:s.querySelector("."+u.subtitles.base),playButton:s.querySelector("."+u.playButton.base),timeWatched:s.querySelector("."+u.time.watched),timeTotal:s.querySelector("."+u.time.total),progressBar:s.querySelector("."+u.progress.bar)};this.state={videoIsPlaying:!1,audioIsPlaying:!1},this.canvasContext=this.elements.canvas.getContext("2d"),this.isPlaying=!1,Promise.all([this._loadVideo(o.video),this._loadSoundtrack(o.soundtrack),this._loadSubtitles(o.subtitles)]).then(function(t){n.video=t[0],n.soundtrack=t[1],n.subtitles=t[2],n._setupCanvas(),n._parseSubtitles(),n._setupTiming(),n._setupSound(),n._addEventListeners(),l.root.classList.add(u.base+"_initialized"),n.play()}),this._onPlayToggle=a.bind(this),this.counter=0,window.player=this}return s(t,[{key:"_setupCanvas",value:function(){var t=(this.video,this.canvasContext,this.elements),e=t.canvas,a=(t.stage,this.canvasSize=this._computeCanvasSize()),i=this.virtualCanvas=document.createElement("canvas");this.virtualCanvasContext=this.virtualCanvas.getContext("2d");e.width=a.width,e.height=a.height,i.width=a.width,i.height=a.height,this._drawFrame()}},{key:"_parseSubtitles",value:function(){this.subtitles=this.subtitles.split("\n\n").map(function(t){var e=t.split("\n"),a=e[1].split(" --> "),i={id:null,start:null,end:null,duration:null,text:null};return i.id=parseInt(e[0],10),i.start=(0,o.formattedTimeToSeconds)(a[0]),i.duration=(0,o.formattedTimeToSeconds)(a[1])-i.start,i.end=i.start+i.duration,i.text=e.slice(2).join("\n"),i})}},{key:"_setupTiming",value:function(){var t=this.subtitles.reduce(function(t,e){return t+e.duration},0),e=Math.round(this.video.duration),a=e+t;this.timing={duration:a,watchedSeconds:0,prevWatchedSecond:0,lastFrameTimestamp:null};var i=0,n=0;this.timeline=this.subtitles.reduce(function(t,e,s,o){var r=(s===o.length-1,o[s+1]),u=o[s-1]||{start:0,end:0,duration:0,isSynthethic:!0},l=u.end+i,d=e.start+i,c=e.end+i;r&&r.start+i;return u.end<e.start&&t.push({start:l,end:d,type:"video"}),t.push({start:d,end:c,type:"video"}),t.push({start:c,end:c+e.duration,type:"subtitles",text:e.text}),i+=e.duration+n,r||t.push({start:e.end+i,end:a,duration:a-e.end+i,type:"video"}),t},[]),this._updateTotalTime()}},{key:"_setupSound",value:function(){var t=this.audioContext=new(window.AudioContext||window.webkitAudioContext),e=this.audioSource=t.createMediaElementSource(this.elements.audio),a=4096,i=function(){var e=0,i=t.createScriptProcessor(a,1,1);return i.onaudioprocess=function(t){for(var i=t.outputBuffer.getChannelData(0),n=0;n<a;n++){var s=2*Math.random()-1;i[n]=(e+.02*s)/1.02,e=i[n],i[n]*=.5}},i}();i.connect(t.destination);var n=t.createWaveShaper(),s=t.createBiquadFilter();s.type="lowpass",s.frequency.value=500,s.gain.value=5,e.connect(n),n.connect(s),s.connect(t.destination)}},{key:"_addEventListeners",value:function(){this.elements}},{key:"_removeEventListeners",value:function(){this.elements}},{key:"_loadVideo",value:function(t){var e=this;return new Promise(function(a,i){var n=e.elements,s=document.createElement("video");s.defaultMuted=!0,s.classList.add(e.classes.video.base),n.stage.appendChild(s),s.addEventListener("error",i),s.addEventListener("canplaythrough",function(t){a(s)}),s.src=t})}},{key:"_loadSoundtrack",value:function(t){var e=this;return new Promise(function(a,i){var n=e.elements,s=n.audio=document.createElement("audio");s.classList.add(e.classes.base+"__audio"),n.stage.appendChild(s),s.addEventListener("error",i),s.addEventListener("canplaythrough",function(t){s.loop=!0,a(s)}),s.src=t})}},{key:"_loadSubtitles",value:function(t){return fetch(t).then(function(t){return t.text()})}},{key:"_playSoundtrack",value:function(){this.state.audioIsPlaying||(this.soundtrack.play(),this.audioContext.resume(),this.state.audioIsPlaying=!0)}},{key:"_playVideo",value:function(){this.state.videoIsPlaying||(this.video.play(),this.state.videoIsPlaying=!0)}},{key:"_pauseSoundtrack",value:function(){this.state.audioIsPlaying&&(this.soundtrack.pause(),this.audioContext.suspend(),this.state.audioIsPlaying=!1)}},{key:"_pauseVideo",value:function(){this.state.videoIsPlaying&&(this.video.pause(),this.state.videoIsPlaying=!1)}},{key:"_updateTotalTime",value:function(){this.elements.timeTotal.innerText=(0,o.formatSeconds)(this.timing.duration)}},{key:"_updateWatchedTime",value:function(t){var e=this.timing,a=e.watchedSeconds,i=e.prevWatchedSeconds,n=e.duration;Math.floor(i)!==Math.floor(a)&&(this.elements.progressBar.style.transform="translate("+(-100+a/n*100)+"%, 0)",this.elements.timeWatched.innerText=(0,o.formatSeconds)(a))}},{key:"_updateTiming",value:function(){var t=this.timing,e=new Date;t.lastFrameTimestamp||(t.lastFrameTimestamp=e),t.prevWatchedSeconds=t.watchedSeconds,t.watchedSeconds+=(e-t.lastFrameTimestamp)/1e3,t.lastFrameTimestamp=e,this._updateWatchedTime()}},{key:"_updateCanvas",value:function(){var t=this.virtualCanvasContext,e=this.canvasSize,a=e.width,i=e.height,n=this.timing.watchedSeconds,s=function(t){return function(e){var a=e.start,i=e.end;return a<=t&&i>t}},o=this.timeline.find(s(n));"video"===o.type&&(this._playVideo(),this.textWasDrawn=!1,t.drawImage(this.video,0,0,a,i)),"subtitles"===o.type&&(this._pauseVideo(),this._drawSubtitles(o.text)),this._applyEffects()}},{key:"_drawSubtitles",value:function(t){if(!this.textWasDrawn){var e=this.virtualCanvasContext,a=this.canvasSize,i=a.width,n=a.height;e.fillStyle="#000000",e.fillRect(0,0,i,n),e.fillStyle="#ffffff";var s=.1*n,o=.05*i,r=28;e.font="20px Oranienbaum",t.split("\n").map(function(t,a){e.fillText(t,o,s+a*r)}),this.textWasDrawn=!0}}},{key:"_applyEffects",value:function(){var t=this.canvasContext,e=this.virtualCanvasContext,a=this.canvasSize,i=a.width,s=a.height,o=this._applyGrayscale(e.getImageData(0,0,i,s));t.putImageData(o,0,0),n(t,i,s),n(t,i,s),n(t,i,s)}},{key:"_applyGrayscale",value:function(t){for(var e=t.data,a=e.length,i=(0,o.getRandom)(.9,1.1),n=0;n<a;n+=4){var s=e[n],r=e[n+1],u=e[n+2],l=(e[n+3],(.21*s+.72*r+.07*u)*i);e[n]=e[n+1]=e[n+2]=l}return t}},{key:"_drawFrame",value:function(){var t=this;this.isPlaying&&window.requestAnimationFrame(function(){t._updateTiming(),t._updateCanvas(),t._drawFrame()})}},{key:"_computeCanvasSize",value:function(t){var e=document.createElement("img"),a=void 0;return e.classList.add(this.classes.fakeVideo.base),e.width=this.video.videoWidth,e.height=this.video.videoHeight,this.elements.stage.appendChild(e),a={width:e.clientWidth,height:e.clientHeight},e.parentNode.removeChild(e),a}},{key:"play",value:function(){var t=this.elements,e=this.classes;this.lastFrameTimestamp=new Date,this.isPlaying=!0,t.playButton.classList.remove(e.playButton.paused),t.playButton.classList.add(e.playButton.playing),this._playSoundtrack(),this._playVideo(),this._drawFrame()}},{key:"pause",value:function(){var t=this.elements,e=this.classes;this.isPlaying=!1,t.playButton.classList.remove(e.playButton.playing),t.playButton.classList.add(e.playButton.paused),this._pauseSoundtrack(),this._pauseVideo()}}]),t}();e.default=r}]);
//# sourceMappingURL=bundle.js.map