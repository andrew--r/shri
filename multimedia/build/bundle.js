!function(t){function e(n){if(a[n])return a[n].exports;var i=a[n]={exports:{},id:n,loaded:!1};return t[n].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var a={};return e.m=t,e.c=a,e.p="",e(0)}([function(t,e,a){"use strict";function n(t){return t&&t.__esModule?t:{"default":t}}function i(){window.application=new o.default}var r=a(2),o=n(r);document.addEventListener("DOMContentLoaded",i)},function(t,e){"use strict";function a(t){var e=Math.floor(t/60);return n(e)+":"+n(Math.round(t%60))}function n(t){var e=void 0;return e=t<10&&t>=1?"0"+Math.round(t):t<1?"00":t.toString()}function i(t){var e=t.split(":"),a=parseInt(e[0],10),n=parseInt(e[1],10),i=Math.round(parseFloat(e[2].replace(",","."),10));return i+60*n+60*a*60}function r(t,e){return Math.floor(Math.random()*(e-t+1))+t}function o(t,e){return Math.random()*(e-t)+t}Object.defineProperty(e,"__esModule",{value:!0}),e.formatSeconds=a,e.formattedTimeToSeconds=i,e.getRandomInt=r,e.getRandom=o;e.webgl={createShader:function(t,e,a){var n=t.createShader(a);t.shaderSource(n,e),t.compileShader(n);var i=t.getShaderParameter(n,t.COMPILE_STATUS);if(!i)throw new Error("Could not compile shader: ",t.getShaderInfoLog(n));return n},createProgram:function(t,e,a){var n=t.createProgram();t.attachShader(n,e),t.attachShader(n,a),t.linkProgram(n);var i=t.getProgramParameter(n,t.LINK_STATUS);if(!i)throw new Error("Program failed to link: ",t.getProgramInfoLog(n));return n}}},function(t,e,a){"use strict";function n(t){return t&&t.__esModule?t:{"default":t}}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=a(3),o=n(r),s=function u(){function t(t){var e=this;t.preventDefault(),Object.keys(this.links).forEach(function(t){e.links[t]=e.form.querySelector('[data-link-type="'+t+'"]').value}),this.pages.start.classList.remove(n),this.pages.main.classList.add(n),window.player=this.player=new o.default({root:this.root.querySelector(".player"),resources:this.links})}var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,u);var a=e.baseClass||"app",n=a+"__page_visible";this.root=document.querySelector("."+a),this.form=this.root.querySelector("."+a+"__form"),this.pages={start:this.root.querySelector("."+a+"__page_start"),main:this.root.querySelector("."+a+"__page_main")},this.links={video:"",subtitles:"",soundtrack:""},this.form.addEventListener("submit",t.bind(this))};e.default=s},function(t,e,a){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t){return new Promise(function(e,a){var n=document.createElement("video");n.muted=!0,n.addEventListener("error",a),n.addEventListener("canplaythrough",function(t){e(n)}),n.src=t})}function r(t){return new Promise(function(e,a){var n=document.createElement("audio");n.addEventListener("error",a),n.addEventListener("canplaythrough",function(t){n.loop=!0,e(n)}),n.src=t})}function o(t){return fetch(t).then(function(t){return t.text()})}function s(t){return t.split("\n\n").map(function(t){var e=t.split("\n"),a=e[1].split(" --> "),n={id:null,start:null,end:null,duration:null,text:null};return n.id=parseInt(e[0],10),n.start=(0,h.formattedTimeToSeconds)(a[0]),n.duration=(0,h.formattedTimeToSeconds)(a[1])-n.start,n.end=n.start+n.duration,n.text=e.slice(2).join("\n"),n})}function u(t,e){var a=0;return t.reduce(function(t,n,i,r){var o=r[i+1],s=r[i-1]||{start:0,end:0,duration:0,isSynthethic:!0},u=s.end+a,l=n.start+a,d=n.end+a;o&&o.start+a;return s.end<n.start&&t.push({start:u,end:l,type:"video"}),t.push({start:l,end:d,type:"video"}),t.push({start:d,end:d+n.duration,type:"subtitles",text:n.text}),a+=n.duration,o||t.push({start:n.end+a,end:e,duration:e-n.end+a,type:"video"}),t},[])}function l(t,e,a){var n={x:(0,h.getRandomInt)(0,e),y:(0,h.getRandomInt)(0,a)},i=2.5,r={x:(0,h.getRandomInt)(n.x-i,n.x+i),y:(0,h.getRandomInt)(n.y-i,n.y+i)},o={x:(0,h.getRandomInt)(n.x-i,n.x+i),y:(0,h.getRandomInt)(n.y-i,n.y+i)},s=(0,h.getRandomInt)(0,150);t.strokeStyle="rgb("+s+", "+s+", "+s+")",t.lineWidth=10,t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(n.x,n.y,o.x,o.y),t.stroke()}function d(t,e,a){var n={x:(0,h.getRandomInt)(0,e),y:(0,h.getRandomInt)(0,a)},i=(0,h.getRandomInt)(5,40),r={x:(0,h.getRandomInt)(n.x-i,n.x+i),y:(0,h.getRandomInt)(n.y-i,n.y+i)},o={x:(0,h.getRandomInt)(n.x-i,n.x+i),y:(0,h.getRandomInt)(n.y-i,n.y+i)},s=(0,h.getRandomInt)(0,100);t.strokeStyle="rgb("+s+", "+s+", "+s+")",t.lineWidth=1,t.beginPath(),t.moveTo(r.x,r.y),t.quadraticCurveTo(n.x,n.y,o.x,o.y),t.stroke()}Object.defineProperty(e,"__esModule",{value:!0});var c=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),h=a(1),f="player",p={base:f,stage:{base:f+"__stage"},canvas:{base:f+"__canvas"},playButton:{base:f+"__control_state",paused:f+"__control_state_play",playing:f+"__control_state_pause"},time:{base:"time",watched:"time__watched",total:"time__total"},fakeVideo:{base:f+"__fakeVideo"},progress:{base:"progress",bar:"progress__bar"}},m=function(){function t(e){var a=this,u=e.root,l=e.resources;n(this,t),this.elements={root:u,stage:u.querySelector("."+p.stage.base),canvas:u.querySelector("."+p.canvas.base),playButton:u.querySelector("."+p.playButton.base),timeWatched:u.querySelector("."+p.time.watched),timeTotal:u.querySelector("."+p.time.total),progressBar:u.querySelector("."+p.progress.bar)},this.state={isPlaying:!1,videoIsPlaying:!1,audioIsPlaying:!1},Promise.all([i(l.video),r(l.soundtrack),o(l.subtitles)]).then(function(t){a.video=t[0],a.audio=t[1],a.subtitles=s(t[2]),a._addEventListeners(),a._setupCanvas(),a._setupTiming(),a._setupSound(),a.elements.root.classList.add(p.base+"_initialized"),a.play()})}return c(t,[{key:"_addEventListeners",value:function(){var t=this,e=this.elements,a=[e.playButton,e.stage];a.map(function(e){return e.addEventListener("click",function(){t[t.state.isPlaying?"pause":"play"]()})})}},{key:"_setupCanvas",value:function(){var t=this.video,e=this.elements,a=e.virtualCanvas=document.createElement("canvas");this.context=e.canvas.getContext("2d"),this.virtualContext=a.getContext("2d"),e.canvas.width=a.width=t.videoWidth,e.canvas.height=a.height=t.videoHeight}},{key:"_setupTiming",value:function(){var t=this.subtitles.reduce(function(t,e){return t+e.duration},0),e=Math.round(this.video.duration),a=e+t;this.timing={duration:a,watchedSeconds:0,prevWatchedSecond:0,lastFrameTimestamp:null},this.timeline=u(this.subtitles,a),this.elements.timeTotal.innerText=(0,h.formatSeconds)(this.timing.duration)}},{key:"_setupSound",value:function(){var t=this.audioContext=new(window.AudioContext||window.webkitAudioContext),e=this.audioSource=t.createMediaElementSource(this.audio),a=function(){var e=4096,a=0,n=t.createScriptProcessor(e,1,1);return n.onaudioprocess=function(t){for(var n=t.outputBuffer.getChannelData(0),i=0;i<e;i++){var r=2*Math.random()-1;n[i]=(a+.02*r)/1.02,a=n[i],n[i]*=.25}},n}();a.connect(t.destination);var n=t.createBiquadFilter();n.type="highpass",n.frequency.value=900,n.gain.value=5,e.connect(n),n.connect(t.destination)}},{key:"_playSoundtrack",value:function(){this.state.audioIsPlaying||(this.audio.play(),this.audioContext.resume(),this.state.audioIsPlaying=!0)}},{key:"_playVideo",value:function(){this.state.videoIsPlaying||(this.state.videoIsPlaying=!0,this.video.play())}},{key:"_pauseSoundtrack",value:function(){this.state.audioIsPlaying&&(this.audio.pause(),this.audioContext.suspend(),this.state.audioIsPlaying=!1)}},{key:"_pauseVideo",value:function(){this.state.videoIsPlaying&&(this.state.videoIsPlaying=!1,this.video.pause())}},{key:"_updateTiming",value:function(){var t=this.timing,e=new Date;t.lastFrameTimestamp||(t.lastFrameTimestamp=e),t.prevWatchedSeconds=t.watchedSeconds,t.watchedSeconds+=(e-t.lastFrameTimestamp)/1e3,t.lastFrameTimestamp=e,this._updateWatchedTime()}},{key:"_updateWatchedTime",value:function(t){var e=this.timing,a=e.watchedSeconds,n=e.prevWatchedSeconds,i=e.duration;Math.floor(n)!==Math.floor(a)&&(this.elements.progressBar.style.transform="translate("+(-100+a/i*100)+"%, 0)",this.elements.timeWatched.innerText=(0,h.formatSeconds)(a))}},{key:"_updateCanvas",value:function(){var t=this.elements,e=this.virtualContext,a=this.timing,n=t.canvas,i=n.width,r=n.height,o=function(t){return function(e){var a=e.start,n=e.end;return a<=t&&n>t}},s=this.timeline.find(o(a.watchedSeconds));e.clearRect(0,0,i,r),"video"===s.type&&(this._playVideo(),this.textWasDrawn=!1,e.drawImage(this.video,0,0,i,r)),"subtitles"===s.type&&(this._pauseVideo(),this._drawSubtitles(s.text)),this._applyEffects()}},{key:"_drawSubtitles",value:function(t){var e=this.virtualContext,a=this.elements,n=a.canvas,i=n.width,r=n.height;e.fillStyle="#000000",e.font="22px Oranienbaum",e.fillRect(0,0,i,r),e.fillStyle="#ffffff";var o=t.split("\n"),s=o.reduce(function(t,e){return e.length>t.length?e:t},""),u=28,l=r/2-o.length*u/2,d=i/2-e.measureText(s).width/2;o.map(function(t,a){e.fillText(t,d,l+a*u)})}},{key:"_applyEffects",value:function(){var t=this.context,e=this.elements,a=e.virtualCanvas,n=a.width,i=a.height;t.drawImage(e.virtualCanvas,0,0,n,i),t.globalCompositeOperation="color",t.fillStyle="#ffffff",t.fillRect(0,0,n,i),t.globalCompositeOperation="source-over",t.globalAlpha=(0,h.getRandom)(0,.2),t.fillStyle="#000000",t.fillRect(0,0,n,i),t.globalAlpha=1,l(t,n,i),l(t,n,i),l(t,n,i),d(t,n,i),d(t,n,i),d(t,n,i)}},{key:"_applyGrayscale",value:function(t){for(var e=t.data,a=e.length,n=(0,h.getRandom)(.9,1.1),i=0;i<a;i+=4){var r=e[i],o=e[i+1],s=e[i+2],u=(e[i+3],(.21*r+.72*o+.07*s)*n);e[i]=e[i+1]=e[i+2]=u}return t}},{key:"_drawFrame",value:function(){var t=this;this.state.isPlaying&&window.requestAnimationFrame(function(){t._updateTiming(),t._updateCanvas(),t._drawFrame()})}},{key:"play",value:function(){var t=this.elements;this.timing.lastFrameTimestamp=new Date,this.state.isPlaying=!0,t.playButton.classList.remove(p.playButton.paused),t.playButton.classList.add(p.playButton.playing),this._playSoundtrack(),this._playVideo(),this._drawFrame()}},{key:"pause",value:function(){var t=this,e=this.elements;this.state.isPlaying=!1,window.requestAnimationFrame(function(){e.playButton.classList.remove(p.playButton.playing),e.playButton.classList.add(p.playButton.paused),t._pauseSoundtrack(),t._pauseVideo()})}}]),t}();e.default=m}]);
//# sourceMappingURL=bundle.js.map